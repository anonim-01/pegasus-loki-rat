{% with previous_page=url_for('webui.agent_list'), title="Exploit Framework" %}
{% include "header.html" %}
{% endwith %}

<div class="container">
    <section id="main_content">
        <div class="tool-interface">
            <!-- Header Section -->
            <div class="page-header">
                <h2>üí• BTS API Exploit Framework</h2>
                <p>Advanced penetration testing tool for BTS API vulnerabilities</p>
            </div>

            <!-- Exploit Configuration -->
            <div class="exploit-config">
                <h3>Exploit Configuration</h3>
                <form id="exploitForm" class="config-form">
                    <div class="form-group">
                        <label for="api_url">BTS API URL:</label>
                        <input type="url" id="api_url" name="api_url" placeholder="https://api.bts.example.com"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="access_token">Access Token:</label>
                        <input type="text" id="access_token" name="access_token" placeholder="Your BTS API access token"
                            required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="thread_count">Thread Count:</label>
                            <input type="number" id="thread_count" name="thread_count" value="5" min="1" max="20">
                        </div>

                        <div class="form-group">
                            <label for="max_retries">Max Retries:</label>
                            <input type="number" id="max_retries" name="max_retries" value="3" min="1" max="10">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="main_api_url">Main API URL:</label>
                        <input type="url" id="main_api_url" name="main_api_url" value="http://127.0.0.1:8080/api"
                            required>
                    </div>

                    <div class="exploit-options">
                        <h4>Exploit Options</h4>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="sql_injection" checked> SQL Injection Tests</label>
                            <label><input type="checkbox" name="xss_tests" checked> XSS Vulnerability Tests</label>
                            <label><input type="checkbox" name="auth_bypass" checked> Authentication Bypass</label>
                            <label><input type="checkbox" name="privilege_escalation" checked> Privilege
                                Escalation</label>
                            <label><input type="checkbox" name="data_extraction" checked> Data Extraction</label>
                            <label><input type="checkbox" name="dos_tests"> DoS Attack Tests</label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" id="configBtn" class="btn btn-secondary">
                            <span class="btn-icon">‚öôÔ∏è</span>
                            Update Config
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-icon">üöÄ</span>
                            Launch Exploit
                        </button>
                        <button type="button" id="stopExploit" class="btn btn-danger" disabled>
                            <span class="btn-icon">‚èπÔ∏è</span>
                            Stop Exploit
                        </button>
                    </div>
                </form>
            </div>

            <!-- Exploit Status -->
            <div class="exploit-status">
                <h3>Exploit Status</h3>
                <div class="status-container">
                    <div id="exploitStatus" class="status-display">
                        <div class="status-indicator">Ready</div>
                        <div class="status-details">
                            <span id="statusText">Configure and launch exploit</span>
                            <span id="processId" class="process-id"></span>
                        </div>
                    </div>

                    <div class="status-actions">
                        <button type="button" id="checkStatus" class="btn btn-info">
                            <span class="btn-icon">üîÑ</span>
                            Check Status
                        </button>
                        <button type="button" id="viewLogs" class="btn btn-info">
                            <span class="btn-icon">üìã</span>
                            View Logs
                        </button>
                        <button type="button" id="downloadReport" class="btn btn-success">
                            <span class="btn-icon">üìä</span>
                            Download Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Exploit Results -->
            <div class="exploit-results">
                <h3>Exploit Results</h3>
                <div class="results-container">
                    <div class="results-tabs">
                        <button class="tab-btn active" data-tab="output">Console Output</button>
                        <button class="tab-btn" data-tab="events">Events</button>
                        <button class="tab-btn" data-tab="vulnerabilities">Vulnerabilities</button>
                    </div>

                    <div class="tab-content">
                        <div id="output-tab" class="tab-pane active">
                            <div class="console-output">
                                <pre
                                    id="consoleText">No exploit output yet. Configure and launch exploit to see results.</pre>
                            </div>
                        </div>

                        <div id="events-tab" class="tab-pane">
                            <div id="eventsList" class="events-list">
                                <!-- Events will be populated here -->
                            </div>
                        </div>

                        <div id="vulnerabilities-tab" class="tab-pane">
                            <div id="vulnResults" class="vuln-results">
                                <!-- Vulnerabilities will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>
    let exploitProcess = null;
    let statusInterval = null;

    $(document).ready(function () {
        $('#configBtn').on('click', updateConfig);
        $('#exploitForm').on('submit', function (e) {
            e.preventDefault();
            launchExploit();
        });
        $('#stopExploit').on('click', stopExploit);
        $('#checkStatus').on('click', checkStatus);
        $('#viewLogs').on('click', viewLogs);
        $('#downloadReport').on('click', downloadReport);

        // Tab switching
        $('.tab-btn').on('click', function () {
            const tabId = $(this).data('tab');
            switchTab(tabId);
        });
    });

    function updateConfig() {
        const configData = {
            api_url: $('#api_url').val(),
            access_token: $('#access_token').val(),
            thread_count: parseInt($('#thread_count').val()),
            max_retries: parseInt($('#max_retries').val()),
            main_api_url: $('#main_api_url').val()
        };

        $.post('/api/bts/config', configData)
            .done(function (response) {
                if (response.ok) {
                    alert('Configuration updated successfully!');
                    $('#statusText').text('Configuration updated - Ready to launch');
                } else {
                    alert('Failed to update configuration: ' + response.error);
                }
            })
            .fail(function () {
                alert('Failed to update configuration. Please try again.');
            });
    }

    function launchExploit() {
        // First update config, then launch
        updateConfigAndLaunch();
    }

    function updateConfigAndLaunch() {
        const configData = {
            api_url: $('#api_url').val(),
            access_token: $('#access_token').val(),
            thread_count: parseInt($('#thread_count').val()),
            max_retries: parseInt($('#max_retries').val()),
            main_api_url: $('#main_api_url').val()
        };

        $.post('/api/bts/config', configData)
            .done(function (response) {
                if (response.ok) {
                    // Config updated, now launch exploit
                    $.post('/api/bts/run')
                        .done(function (runResponse) {
                            if (runResponse.ok) {
                                exploitProcess = runResponse.pid;
                                $('#statusText').text('Exploit launched successfully');
                                $('#processId').text('PID: ' + runResponse.pid);
                                $('.status-indicator').text('Running').addClass('running');

                                // Disable launch button, enable stop button
                                $('#exploitForm button[type="submit"]').prop('disabled', true);
                                $('#stopExploit').prop('disabled', false);

                                // Start monitoring
                                statusInterval = setInterval(checkStatus, 3000);

                                // Start simulating output
                                simulateExploitOutput();
                            } else {
                                alert('Failed to launch exploit: ' + runResponse.message);
                            }
                        })
                        .fail(function () {
                            alert('Failed to launch exploit. Please try again.');
                        });
                } else {
                    alert('Failed to update configuration: ' + response.error);
                }
            })
            .fail(function () {
                alert('Failed to update configuration. Please try again.');
            });
    }

    function stopExploit() {
        if (statusInterval) {
            clearInterval(statusInterval);
            statusInterval = null;
        }

        $('.status-indicator').text('Stopped').removeClass('running');
        $('#statusText').text('Exploit stopped');
        $('#processId').text('');

        // Reset buttons
        $('#exploitForm button[type="submit"]').prop('disabled', false);
        $('#stopExploit').prop('disabled', true);

        exploitProcess = null;
    }

    function checkStatus() {
        $.get('/api/bts/status')
            .done(function (response) {
                if (response.ok && response.status) {
                    if (response.status.running) {
                        $('.status-indicator').text('Running').addClass('running');
                        $('#statusText').text('Exploit is running');
                        $('#processId').text('PID: ' + response.status.pid);
                    } else {
                        $('.status-indicator').text('Completed').removeClass('running');
                        $('#statusText').text('Exploit completed');
                        $('#processId').text('Exit code: ' + (response.status.returncode || 0));

                        if (statusInterval) {
                            clearInterval(statusInterval);
                            statusInterval = null;
                        }

                        // Reset buttons
                        $('#exploitForm button[type="submit"]').prop('disabled', false);
                        $('#stopExploit').prop('disabled', true);
                    }
                }
            })
            .fail(function () {
                console.log('Failed to check status');
            });
    }

    function viewLogs() {
        $.get('/api/bts/log?lines=100')
            .done(function (response) {
                if (response.ok) {
                    $('#consoleText').text(response.lines.join(''));
                    switchTab('output');
                } else {
                    alert('Failed to load logs: ' + response.error);
                }
            })
            .fail(function () {
                alert('Failed to load logs. Please try again.');
            });
    }

    function downloadReport() {
        window.open('/api/bts/report', '_blank');
    }

    function switchTab(tabId) {
        $('.tab-btn').removeClass('active');
        $('.tab-pane').removeClass('active');

        $(`[data-tab="${tabId}"]`).addClass('active');
        $(`#${tabId}-tab`).addClass('active');
    }

    function simulateExploitOutput() {
        const outputs = [
            '[INFO] Starting BTS API exploit framework...',
            '[INFO] Target API: ' + $('#api_url').val(),
            '[INFO] Thread count: ' + $('#thread_count').val(),
            '[SCAN] Loading payload list...',
            '[SCAN] Testing authentication bypass...',
            '[VULN] Found potential SQL injection in parameter "id"',
            '[SCAN] Testing privilege escalation...',
            '[INFO] Attempting data extraction...',
            '[SUCCESS] Successfully extracted user data',
            '[VULN] Found XSS vulnerability in search function',
            '[SCAN] Testing for additional vulnerabilities...',
            '[INFO] Generating summary report...',
            '[COMPLETE] Exploit framework finished'
        ];

        let index = 0;
        const outputInterval = setInterval(function () {
            if (index < outputs.length && exploitProcess) {
                const currentOutput = $('#consoleText').text();
                $('#consoleText').text(currentOutput + '\n' + outputs[index]);

                // Add events and vulnerabilities
                if (outputs[index].includes('[VULN]')) {
                    addVulnerability(outputs[index]);
                }

                addEvent(outputs[index]);

                index++;

                // Auto-scroll to bottom
                $('.console-output').scrollTop($('.console-output')[0].scrollHeight);
            } else {
                clearInterval(outputInterval);
            }
        }, 2000);
    }

    function addEvent(eventText) {
        const timestamp = new Date().toLocaleTimeString();
        const eventType = eventText.includes('[VULN]') ? 'vulnerability' :
            eventText.includes('[SUCCESS]') ? 'success' :
                eventText.includes('[ERROR]') ? 'error' : 'info';

        const eventHtml = `
    <div class="event-item ${eventType}">
      <div class="event-time">${timestamp}</div>
      <div class="event-text">${eventText}</div>
    </div>
  `;
        $('#eventsList').append(eventHtml);
    }

    function addVulnerability(vulnText) {
        const severity = vulnText.includes('SQL injection') ? 'critical' :
            vulnText.includes('XSS') ? 'high' : 'medium';

        const vulnHtml = `
    <div class="vuln-item ${severity}">
      <div class="vuln-severity">${severity.toUpperCase()}</div>
      <div class="vuln-description">${vulnText.replace('[VULN]', '').trim()}</div>
      <div class="vuln-actions">
        <button class="btn-small btn-info">Details</button>
        <button class="btn-small btn-success">Exploit</button>
      </div>
    </div>
  `;
        $('#vulnResults').append(vulnHtml);
    }
</script>

<style>
    .tool-interface {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        border: 1px solid #ff6b35;
        border-radius: 10px;
    }

    .page-header h2 {
        color: #ff6b35;
        margin-bottom: 10px;
        text-shadow: 0 0 10px rgba(255, 107, 53, 0.5);
    }

    .exploit-config {
        background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
        border: 1px solid #333;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .exploit-config h3 {
        color: #ff6b35;
        margin-bottom: 20px;
    }

    .config-form {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .form-row {
        display: flex;
        gap: 20px;
    }

    .form-group {
        flex: 1;
    }

    .form-group label {
        display: block;
        color: #ccc;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input {
        width: 100%;
        padding: 10px;
        background: #333;
        border: 1px solid #555;
        border-radius: 5px;
        color: #fff;
        font-size: 14px;
    }

    .form-group input:focus {
        border-color: #ff6b35;
        outline: none;
        box-shadow: 0 0 5px rgba(255, 107, 53, 0.3);
    }

    .exploit-options h4 {
        color: #ff6b35;
        margin-bottom: 10px;
    }

    .checkbox-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
    }

    .checkbox-group label {
        display: flex;
        align-items: center;
        color: #ccc;
        cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .exploit-status {
        background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
        border: 1px solid #333;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .exploit-status h3 {
        color: #ff6b35;
        margin-bottom: 20px;
    }

    .status-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 20px;
    }

    .status-display {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .status-indicator {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        background: #333;
        color: #ccc;
        border: 2px solid #555;
    }

    .status-indicator.running {
        background: #ff6b35;
        color: white;
        border-color: #ff6b35;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }

        100% {
            opacity: 1;
        }
    }

    .status-details {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .process-id {
        font-family: 'Courier New', monospace;
        color: #00ff41;
        font-size: 12px;
    }

    .status-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .exploit-results {
        background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
        border: 1px solid #333;
        border-radius: 10px;
        padding: 20px;
    }

    .exploit-results h3 {
        color: #ff6b35;
        margin-bottom: 20px;
    }

    .results-tabs {
        display: flex;
        border-bottom: 1px solid #333;
        margin-bottom: 20px;
    }

    .tab-btn {
        padding: 10px 20px;
        background: none;
        border: none;
        color: #ccc;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
    }

    .tab-btn.active {
        color: #ff6b35;
        border-bottom-color: #ff6b35;
    }

    .tab-btn:hover {
        color: #ff6b35;
    }

    .tab-pane {
        display: none;
    }

    .tab-pane.active {
        display: block;
    }

    .console-output {
        background: #000;
        border: 1px solid #333;
        border-radius: 5px;
        padding: 15px;
        height: 400px;
        overflow-y: auto;
    }

    .console-output pre {
        color: #00ff41;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        margin: 0;
        white-space: pre-wrap;
    }

    .events-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .event-item {
        display: flex;
        align-items: center;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
        border-left: 4px solid;
    }

    .event-item.info {
        background: rgba(0, 123, 255, 0.1);
        border-left-color: #007bff;
    }

    .event-item.success {
        background: rgba(40, 167, 69, 0.1);
        border-left-color: #28a745;
    }

    .event-item.vulnerability {
        background: rgba(255, 107, 53, 0.1);
        border-left-color: #ff6b35;
    }

    .event-item.error {
        background: rgba(220, 53, 69, 0.1);
        border-left-color: #dc3545;
    }

    .event-time {
        font-family: 'Courier New', monospace;
        color: #666;
        font-size: 12px;
        margin-right: 15px;
        min-width: 80px;
    }

    .event-text {
        color: #ccc;
        flex: 1;
    }

    .vuln-results {
        max-height: 400px;
        overflow-y: auto;
    }

    .vuln-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        border-left: 4px solid;
    }

    .vuln-item.critical {
        background: rgba(220, 53, 69, 0.1);
        border-left-color: #dc3545;
    }

    .vuln-item.high {
        background: rgba(255, 107, 53, 0.1);
        border-left-color: #ff6b35;
    }

    .vuln-item.medium {
        background: rgba(255, 193, 7, 0.1);
        border-left-color: #ffc107;
    }

    .vuln-severity {
        font-weight: bold;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 12px;
        margin-right: 15px;
        min-width: 80px;
        text-align: center;
    }

    .vuln-item.critical .vuln-severity {
        background: #dc3545;
        color: white;
    }

    .vuln-item.high .vuln-severity {
        background: #ff6b35;
        color: white;
    }

    .vuln-item.medium .vuln-severity {
        background: #ffc107;
        color: black;
    }

    .vuln-description {
        color: #ccc;
        flex: 1;
        margin-right: 15px;
    }

    .vuln-actions {
        display: flex;
        gap: 5px;
    }

    .btn-small {
        padding: 5px 10px;
        font-size: 12px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-small.btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-small.btn-success {
        background: #28a745;
        color: white;
    }

    .btn-small:hover {
        opacity: 0.8;
        transform: scale(1.05);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .form-row {
            flex-direction: column;
        }

        .checkbox-group {
            grid-template-columns: 1fr;
        }

        .form-actions,
        .status-actions {
            flex-direction: column;
        }

        .status-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .results-tabs {
            flex-wrap: wrap;
        }
    }
</style>

{% include "footer.html" %}